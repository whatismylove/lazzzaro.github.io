<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>反序列化 | Lazzaro</title><meta name="description" content="概念：序列化就是使用serialize()将对象的用字符串的方式进行表示，反序列化是使用unserialize()将序列化的字符串，构造成相应的对象，反序列化是序列化的逆过程。 序列化的对象可以是class也可以是Array,string等其他对象。 问题原因：漏洞的根源在于unserialize()函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码或变量用户可控，就可能产生反序"><meta property="og:type" content="article"><meta property="og:title" content="反序列化"><meta property="og:url" content="https://lazzzaro.github.io/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><meta property="og:site_name" content="Lazzaro"><meta property="og:description" content="概念：序列化就是使用serialize()将对象的用字符串的方式进行表示，反序列化是使用unserialize()将序列化的字符串，构造成相应的对象，反序列化是序列化的逆过程。 序列化的对象可以是class也可以是Array,string等其他对象。 问题原因：漏洞的根源在于unserialize()函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码或变量用户可控，就可能产生反序"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://lazzzaro.github.io/.io//20191112223227-402c9c0c-0559-1.png"><meta property="article:published_time" content="2020-05-14T17:10:23.000Z"><meta property="article:modified_time" content="2021-10-03T08:45:41.914Z"><meta property="article:author" content="Lazzaro"><meta property="article:tag" content="python"><meta property="article:tag" content="反序列化"><meta property="article:tag" content="PHP"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://lazzzaro.github.io/.io//20191112223227-402c9c0c-0559-1.png"><link rel="canonical" href="https://lazzzaro.github.io/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><link rel="alternate" href="/atom.xml" title="Lazzaro" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/Lazzzaro" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Lazzaro</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">CTF弱鸡自进阶</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> flag{}___Orz</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">总览</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">汇总</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">类别</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">关键词</span></a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook"><i class="icon"></i> <span class="menu-title">来留个言 👉👉👉</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/Lazzzaro" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">类别</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/crypto/">crypto</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/match/">match</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/misc/">misc</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">13</span></li></ul></div></div><div class="widget"><h3 class="widget-title">关键词云</h3><div class="widget-body tagcloud"><a href="/tags/2020%E8%B5%9B/" style="font-size:14px">2020赛</a> <a href="/tags/2021%E8%B5%9B/" style="font-size:13.8px">2021赛</a> <a href="/tags/AES/" style="font-size:13px">AES</a> <a href="/tags/Android/" style="font-size:13px">Android</a> <a href="/tags/Bash/" style="font-size:13px">Bash</a> <a href="/tags/CMS/" style="font-size:13px">CMS</a> <a href="/tags/CSRF/" style="font-size:13px">CSRF</a> <a href="/tags/DES/" style="font-size:13px">DES</a> <a href="/tags/ECC/" style="font-size:13px">ECC</a> <a href="/tags/IDA/" style="font-size:13px">IDA</a> <a href="/tags/JWT/" style="font-size:13px">JWT</a> <a href="/tags/Linux/" style="font-size:13px">Linux</a> <a href="/tags/OT/" style="font-size:13px">OT</a> <a href="/tags/PHP/" style="font-size:13.4px">PHP</a> <a href="/tags/RCE/" style="font-size:13px">RCE</a> <a href="/tags/RSA/" style="font-size:13.2px">RSA</a> <a href="/tags/SQL/" style="font-size:13px">SQL</a> <a href="/tags/SSRF/" style="font-size:13px">SSRF</a> <a href="/tags/SSTI/" style="font-size:13px">SSTI</a> <a href="/tags/Sage/" style="font-size:13px">Sage</a> <a href="/tags/USB/" style="font-size:13px">USB</a> <a href="/tags/Unity/" style="font-size:13px">Unity</a> <a href="/tags/XSS/" style="font-size:13px">XSS</a> <a href="/tags/angr/" style="font-size:13px">angr</a> <a href="/tags/fuzz/" style="font-size:13px">fuzz</a> <a href="/tags/gmpy2/" style="font-size:13px">gmpy2</a> <a href="/tags/nodejs/" style="font-size:13px">nodejs</a> <a href="/tags/pwntools/" style="font-size:13px">pwntools</a> <a href="/tags/python/" style="font-size:13.6px">python</a> <a href="/tags/z3/" style="font-size:13px">z3</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size:13px">反序列化</a> <a href="/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/" style="font-size:13px">反编译</a> <a href="/tags/%E5%8F%8D%E8%B0%83%E8%AF%95/" style="font-size:13px">反调试</a> <a href="/tags/%E5%8F%96%E8%AF%81/" style="font-size:13px">取证</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E8%A1%8C/" style="font-size:13px">命令行</a> <a href="/tags/%E5%9B%BE%E5%83%8F/" style="font-size:13px">图像</a> <a href="/tags/%E5%9D%97%E5%AF%86%E7%A0%81/" style="font-size:13px">块密码</a> <a href="/tags/%E5%AF%86%E7%A0%81/" style="font-size:13.2px">密码</a> <a href="/tags/%E6%8F%90%E6%9D%83/" style="font-size:13px">提权</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size:13px">文件上传</a> <a href="/tags/%E6%9B%B2%E7%BA%BF/" style="font-size:13px">曲线</a> <a href="/tags/%E6%A0%BC%E5%AF%86%E7%A0%81/" style="font-size:13px">格密码</a> <a href="/tags/%E6%B3%A8%E5%85%A5/" style="font-size:13px">注入</a> <a href="/tags/%E6%B5%81%E5%AF%86%E7%A0%81/" style="font-size:13px">流密码</a> <a href="/tags/%E6%B5%81%E9%87%8F/" style="font-size:13px">流量</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size:13px">渗透</a> <a href="/tags/%E7%A6%BB%E6%95%A3%E5%AF%B9%E6%95%B0/" style="font-size:13px">离散对数</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:13.2px">算法</a> <a href="/tags/%E7%BB%95%E8%BF%87/" style="font-size:13.2px">绕过</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size:13px">编码</a> <a href="/tags/%E8%84%9A%E6%9C%AC/" style="font-size:13.2px">脚本</a> <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/" style="font-size:13px">自动化</a> <a href="/tags/%E9%80%83%E9%80%B8/" style="font-size:13px">逃逸</a> <a href="/tags/%E9%9A%90%E5%86%99/" style="font-size:13.4px">隐写</a></div></div><div class="widget"><h3 class="widget-title">汇总</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">24</span></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">序列化格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.</span> <span class="toc-text">三种访问控制的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">魔术方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">绕过方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#wakeup-%E5%A4%B1%E6%95%88"><span class="toc-number">4.0.1.</span> <span class="toc-text">__wakeup()失效</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87preg-match"><span class="toc-number">4.0.2.</span> <span class="toc-text">绕过preg_match()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">4.0.3.</span> <span class="toc-text">绕过关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%89%B9%E6%80%A7"><span class="toc-number">4.0.4.</span> <span class="toc-text">其他特性</span></a></li></ol></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-number">5.</span> <span class="toc-text">反序列化字符逃逸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87phar-%E4%B8%8D%E8%83%BD%E5%87%BA%E7%8E%B0%E5%9C%A8%E9%A6%96%E9%83%A8"><span class="toc-number">6.0.1.</span> <span class="toc-text">绕过phar:&#x2F;&#x2F;不能出现在首部</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">PHP session反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Soap%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">Soap反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">python反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">10.</span> <span class="toc-text">JDBC反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE%EF%BC%89"><span class="toc-number">11.</span> <span class="toc-text">框架反序列化（CVE）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Yii2"><span class="toc-number">11.0.1.</span> <span class="toc-text">Yii2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Laravel"><span class="toc-number">11.0.2.</span> <span class="toc-text">Laravel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ThinkPHP"><span class="toc-number">11.0.3.</span> <span class="toc-text">ThinkPHP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHPGGC"><span class="toc-number">12.</span> <span class="toc-text">PHPGGC</span></a></li></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-web-反序列化" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">反序列化</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date"><time datetime="2020-05-14T17:10:23.000Z" itemprop="datePublished">2020-05-15</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/web/">web</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/PHP/" rel="tag">PHP</a>, <a class="article-tag-link-link" href="/tags/python/" rel="tag">python</a>, <a class="article-tag-link-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="leancloud_visitors" data-flag-title="反序列化"><span class="leancloud-visitors-count">∞</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/05/15/web-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>概念：序列化就是使用<strong>serialize()</strong>将对象的用字符串的方式进行表示，反序列化是使用<strong>unserialize()</strong>将序列化的字符串，构造成相应的对象，反序列化是序列化的逆过程。 序列化的对象可以是<strong>class</strong>也可以是<strong>Array,string</strong>等其他对象。</p><p>问题原因：漏洞的根源在于<strong>unserialize()</strong>函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码或变量用户可控，就可能产生反序列化漏洞，根据反序列化后不同的代码可以导致各种攻击，如代码注入、SQL注入、目录遍历等等。</p><p>​</p><h3 id="序列化格式"><a href="#序列化格式" class="headerlink" title="序列化格式"></a>序列化格式</h3><p>对象类型:对象名长度:”对象名”:对象成员变量个数:{变量1类型:变量名1长度:变量名1; 参数1类型:参数1长度:参数1; 变量2类型:变量名2长度:”变量名2”; 参数2类型:参数2长度:参数2;… …}</p><p>如：</p><p>O:6:”Person”:2:{s:12:” Person name”;s:8:”Thinking”;s:11:” Person sex”;s:3:”man”;} a:2:{s:4:”name”;s:8:”Thinking”;s:3:”sex”;s:3:”man”;}</p><p><strong>对象类型：</strong>Class-O，Array-a。</p><p><strong>变量和参数类型：</strong>string-s，int-i，Array-a，引用-R。</p><p><strong>序列符号：</strong>参数与变量之间用分号(;)隔开，同一变量和同一参数之间的数据用冒号(:)隔开。</p><div class="table-container"><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:center">结构</th></tr></thead><tbody><tr><td style="text-align:center">String</td><td style="text-align:center">s:size:value;</td></tr><tr><td style="text-align:center">Integer</td><td style="text-align:center">i:value;</td></tr><tr><td style="text-align:center">Boolean</td><td style="text-align:center">b:value;(保存1或0)</td></tr><tr><td style="text-align:center">Null</td><td style="text-align:center">N;</td></tr><tr><td style="text-align:center">Array</td><td style="text-align:center">a:size:{key definition;value definition;(repeated per element)}</td></tr><tr><td style="text-align:center">Object</td><td style="text-align:center">O:strlen(object name):object name:object size:{s:strlen(property name):property name:property definition;(repeated per property)}</td></tr><tr><td style="text-align:center">Reference</td><td style="text-align:center">R:2;</td></tr></tbody></table></div><p>​</p><h3 id="三种访问控制的区别"><a href="#三种访问控制的区别" class="headerlink" title="三种访问控制的区别"></a>三种访问控制的区别</h3><p>public: <strong>变量名</strong></p><p>protected: <strong>\x00 + * + \x00 + 变量名</strong>（或 <strong>\00 + * + \00 + 变量名</strong> 或 <strong>%00 + * + %00 + 变量名</strong>）</p><p>private: <strong>\x00 + 类名 + \x00 + 变量名</strong>（或 <strong>\00 + 类名 + \00 + 变量名</strong> 或 <strong>%00 + 类名 + %00 + 变量名</strong>）</p><p>注：&gt;=php v7.2 反序列化对访问类别不敏感（protected -&gt; public）</p><p>​</p><h3 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__construct()  <span class="comment">#当对象创建时自动被调用</span></span><br><span class="line">__destruct()  <span class="comment">#当脚本运行结束时自动被调用</span></span><br><span class="line">__sleep()  <span class="comment">#当对象序列化的时候自动被调用</span></span><br><span class="line">__wakeup()  <span class="comment">#当反序列化为对象时自动被调用</span></span><br><span class="line">__toString()  <span class="comment">#当对象被当作字符串使用时自动被调用</span></span><br><span class="line">__call()  <span class="comment">#当要调用的方法不存在或权限不足时自动被调用</span></span><br><span class="line">__invoke()  <span class="comment">#当把一个类当作函数使用时自动被调用</span></span><br><span class="line">__autoload()  <span class="comment">#尝试加载未定义的类</span></span><br><span class="line">__get()  <span class="comment">#尝试访问类中私有属性或不存在的属性时被调用</span></span><br></pre></td></tr></table></figure><p>​</p><h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><ul><li><h5 id="wakeup-失效"><a href="#wakeup-失效" class="headerlink" title="__wakeup()失效"></a>__wakeup()失效</h5><p><code>版本：PHP5&lt;5.6.25 或 PHP7&lt;7.0.10</code></p><p>当序列化字符串中，如果表示对象属性个数的值大于真实的属性个数时就会跳过__wakeup()的执行。</p><p>如：<code>O:4:&quot;Demo&quot;:2:&#123;s:10:&quot;Demofile&quot;;s:16:&quot;f15g_1s_here.php&quot;;&#125;</code></p></li><li><h5 id="绕过preg-match"><a href="#绕过preg-match" class="headerlink" title="绕过preg_match()"></a>绕过preg_match()</h5><p>可使用<code>+</code>，<code>&lt;</code>绕过正则，如：</p><p><code>O:+4:&quot;Demo&quot;:1:&#123;s:10:&quot;Demofile&quot;;s:16:&quot;f15g_1s_here.php&quot;;&#125;</code></p><p><code>O:&lt;4:&quot;Demo&quot;:1:&#123;s:10:&quot;Demofile&quot;;s:16:&quot;f15g_1s_here.php&quot;;&#125;</code></p></li><li><h5 id="绕过关键字"><a href="#绕过关键字" class="headerlink" title="绕过关键字"></a>绕过关键字</h5><p>PHP序列化中存在序列化类型 <code>S</code>，相较于小写的 <code>s</code>，大写 <code>S</code> 是escaped字符串，会将 <code>\xx</code> 形式作为一个16进制字符处理，如：</p><p><code>n</code> 的十六进制是 <code>6e</code>，所以把 <code>name</code>替换为 <code>\6eame</code> 即可绕过。</p></li><li><h5 id="其他特性"><a href="#其他特性" class="headerlink" title="其他特性"></a>其他特性</h5><ul><li><p><strong>unserialize_callback_func + spl_autoload</strong></p><p>在 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/var.configuration.php#ini.unserialize-callback-func">php manual</a> 里面有一个很有趣的变量配置，如果在反序列化的时候需要实例化一个未定义的类，可以设置回调函数以供调用，最关键的是这个配置是 PHP_IN_ALL 的，所以可以直接通过 ini_set 来设置。</p><blockquote><p><strong>注意</strong>: <strong>unserialize_callback_func 指令</strong></p><p>如果在反序列化的时候需要实例化一个未定义类，则可以设置回调函数以供调用（以免得到的是不完整的 object “__PHP_Incomplete_Class”）。可通过 php.ini、<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.ini-set.php">ini_set()</a> 或 .htaccess 定义‘unserialize_callback_func’。每次实例化一个未定义类时它都会被调用。若要禁止这个特性，只需置空此设定。</p></blockquote><p>可以通过 <strong>spl_autoload</strong> 来自动加载未定义的类 settings，会默认加载当前目录下，以settings类名为文件名，php 或者 inc 为后缀的文件，这样就和 settings.inc 联系到了一起。</p><blockquote><p><strong>spl_autoload</strong> — __autoload()函数的默认实现</p><p>spl_autoload ( string <code>$class_name</code> , string <code>$file_extensions</code> = ? ) : void</p><p>file_extensions: 在默认情况下，本函数先将类名转换成小写，再在小写的类名后加上 .inc 或 .php 的扩展名作为文件名，然后在所有的包含路径(include paths)中检查是否存在该文件。</p></blockquote></li></ul></li></ul><p>​</p><h3 id="反序列化字符逃逸"><a href="#反序列化字符逃逸" class="headerlink" title="反序列化字符逃逸"></a>反序列化字符逃逸</h3><p>PHP 在反序列化时，底层代码是以 <code>;</code> 作为字段的分隔，以 <code>&#125;</code> 作为结尾(字符串除外)，并且是根据长度判断内容的。</p><p>例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;yy&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="string">&quot;peri0d&quot;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;aaaaa&quot;</span>;</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">array</span>(<span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">var_dump(serialize(<span class="variable">$user</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$r</span> = filter(serialize(<span class="variable">$user</span>));</span><br><span class="line"></span><br><span class="line">var_dump(<span class="variable">$r</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">var_dump(unserialize(<span class="variable">$r</span>));</span><br></pre></td></tr></table></figure><ol><li><p>正常情况下的序列化结果为 <code>a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;</code>。</p></li><li><p>那如果把 <code>username</code> 换成 <code>peri0dxxx</code> ，其处理后的序列化结果为</p><p><code>a:2:&#123;i:0;s:9:&quot;peri0dyyyyyy&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;</code> ，</p><p>这个时候肯定会反序列化失败，可以看到 <code>s:9:&quot;peri0dyyyyyy&quot;</code> 比以前多了 3 个字符。</p></li><li><p>回到前面， <code>a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;</code></p><p>它在进行修改密码之后就变为</p><p><code>a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;s:6:&quot;123456&quot;;&#125;i:1;s:5:&quot;aaaaa&quot;;&#125;</code>。</p></li><li><p>可以看到需要添加的字符串 <code>&quot;;i:1;s:6:&quot;123456&quot;;&#125;</code> 长度为 <code>20</code>。</p></li><li><p>假设要在 <code>peri0d</code> 后面填充 <code>4</code> 个字符，那么就是</p><p><code>s:30:&#39;peri0dxxxx&quot;;i:1;s:6:&quot;123456&quot;;&#125;&#39;;</code></p><p>在经过处理之后就是</p><p><code>s:30:&#39;peri0dyyyyyyyy&quot;;i:1;s:6:&quot;123456&quot;;&#125;&#39;;</code></p><p>读取 <code>30</code> 个字符为 <code>peri0dyyyyyyyy&quot;;i:1;s:6:&quot;12345</code>。</p></li><li><p>这就需要继续增加填充字符，在有 <code>20</code> 个 <code>x</code> 时，就实现了密码的修改。</p><p>$6+x+20=6+2x \Rightarrow x=20$</p><p><img src="/.io//20191112223227-402c9c0c-0559-1.png" alt="20191112223227-402c9c0c-0559-1"></p></li><li><p>可以看到，这和 <code>username</code> 前面的 <code>peri0d</code> 是<strong>毫无关系</strong>的，<strong>只和做替换的字符串有关</strong>。</p></li></ol><p>​</p><h3 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h3><p>phar文件本质上是一种压缩文件，在使用phar协议文件包含时，也是可以直接读取zip文件的。使用phar://协议读取文件时，文件会被解析成phar对象，phar对象内的以序列化形式存储的用户自定义元数据（metadata）信息会被反序列化。这就引出了我们攻击手法最核心的流程。</p><p>流程：构造phar（元数据中含有恶意序列化内容）文件—&gt;上传—&gt;触发反序列化</p><p>最后一步是寻找触发phar文件元数据反序列化。其实php中有一大部分的文件系统函数在通过phar://伪协议解析phar文件时都会将meta-data进行反序列化。</p><p><strong>利用条件</strong></p><ul><li><p>phar文件要能够上传到服务器端。能触发的文件操作函数：</p><p>include、file_get_contents、file_put_contents、copy、file、file_exists、is_executable、is_file、is_dir、is_link、is_writable、fileperms、fileinode、filesize、fileowner、filegroup、fileatime、filemtime、filectime、filetype、getimagesize、exif_read_data、stat、lstat、touch、md5_file</p></li><li><p>要有可用的魔术方法作为“跳板”。</p></li><li><p>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</p></li></ul><p><strong>生成phar文件</strong></p><p>首先得生成一个含有序列化metadata的phar文件。php提供一个类允许我们处理phar文件相关操作。注意要设置php.ini中<strong>phar.readonly=Off</strong>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">Public</span> <span class="variable">$name</span>；</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar，生成后可以随意修改</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> User();   </span><br><span class="line"><span class="variable">$o</span>-&gt;name = <span class="string">&#x27;JrXnm&#x27;</span>;</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>tar包装：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">Public</span> <span class="variable">$name</span>；</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> User();   </span><br><span class="line"><span class="variable">$o</span>-&gt;name = <span class="string">&#x27;JrXnm&#x27;</span>;</span><br><span class="line">@unlink(<span class="string">&quot;phar.tar&quot;</span>);</span><br><span class="line">@system(<span class="string">&#x27;rm -r .phar&#x27;</span>);</span><br><span class="line">@system(<span class="string">&#x27;mkdir .phar&#x27;</span>);</span><br><span class="line">file_put_contents(<span class="string">&#x27;.phar/.metadata&#x27;</span>,serialize(<span class="variable">$o</span>));</span><br><span class="line">system(<span class="string">&#x27;tar -cf phar.tar .phar/*&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// phar://./phar.tar</span></span><br><span class="line"><span class="comment">// phar:///var/www/html/uploads/phar.tar</span></span><br></pre></td></tr></table></figure><p>zip包装：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">Public</span> <span class="variable">$name</span>；</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> User();   </span><br><span class="line"><span class="variable">$o</span>-&gt;name = <span class="string">&#x27;JrXnm&#x27;</span>;</span><br><span class="line"><span class="variable">$d</span> = serialize(<span class="variable">$o</span>);</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="string">&#x27;phar.zip&#x27;</span>)) &#123;</span><br><span class="line">    @unlink(<span class="string">&quot;phar.zip&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> ZipArchive;</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$zip</span>-&gt;open(<span class="string">&#x27;phar.zip&#x27;</span>, ZipArchive::CREATE);</span><br><span class="line"><span class="variable">$zip</span>-&gt;addFromString(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;file content goes here&#x27;</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;setArchiveComment(<span class="variable">$d</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;close();</span><br><span class="line"></span><br><span class="line"><span class="comment">// phar://./phar.zip</span></span><br><span class="line"><span class="comment">// phar:///var/www/html/uploads/phar.zip</span></span><br></pre></td></tr></table></figure><p><strong>上传到服务器</strong></p><p>phar文件是很容易绕过上传限制的，首先它的后缀是不限制的，改成什么phar://协议都可以解析。</p><p>前面这个标志的格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code> 前面内容不限，这样可以在前面添加注入<code>GIF98a</code>这样的文件头绕过上传限制。</p><p><strong>反序列化执行</strong></p><p>直接执行测试的那份代码，phar://协议在file_get_contents函数中解析phar文件，将元数据反序列化执行魔法函数。</p><ul><li><h5 id="绕过phar-不能出现在首部"><a href="#绕过phar-不能出现在首部" class="headerlink" title="绕过phar://不能出现在首部"></a>绕过phar://不能出现在首部</h5><p>利用<code>compress.zlib://</code> 或<code>compress.bzip2://</code>：</p><p><code>compress.zlib://phar://phar.phar/test.txt</code></p><p>其他利用法：</p><p><code>php://filter/resource=phar://</code>、<code>zlib:phar://</code>。</p></li></ul><p>​</p><h3 id="PHP-session反序列化"><a href="#PHP-session反序列化" class="headerlink" title="PHP session反序列化"></a>PHP session反序列化</h3><p>PHP中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。存储的文件是以sess_[sessionid]来进行命名的。</p><p>有三种方式：</p><ul><li><p>默认使用php：键名|键值（经过序列化函数处理的值）</p><p><code>name|s:6:&quot;1FonlY&quot;;</code></p></li><li><p>php_serialize：经过序列化函数处理的值</p><p><code>a:1:&#123;s:4:&quot;name&quot;;s:6:&quot;1FonlY&quot;;&#125;</code></p></li><li><p>php_binary：键名的长度对应的ASCII字符 + 键名 + 经过序列化函数处理的值</p><p><code>names:6:&quot;1FonlY&quot;;</code></p><p>不可显的为<code>EOT</code> ,<code>name</code>的长度为<code>4</code> 4在ASCII 表中就是 EOT</p></li></ul><p><strong>当序列化的引擎和反序列化的引擎不一致时，就可以利用引擎之间的差异产生序列化注入漏洞。</strong></p><p>比如这里先实例化一个对象，然后将其序列化为 <code>O:7:&quot;_1FonlY&quot;:1:&#123;s:3:&quot;cmd&quot;;N;&#125;</code>，</p><p>如果传入 <code>|O:7:&quot;_1FonlY&quot;:1:&#123;s:3:&quot;cmd&quot;;N;&#125;</code>，在使用<code>php_serialize</code> 引擎的时候，</p><p>序列化后的session 文件是这样的 <code>a:1:&#123;s:4:&quot;name&quot;;s:31:&quot;|O:7:&quot;_1FonlY&quot;:1:&#123;s:3:&quot;cmd&quot;;N;&#125;&quot;;&#125;</code>，</p><p>这时，将<code>a:1:&#123;s:4:&quot;name&quot;;s:31:&quot;</code> 当做键名，<code>O:7:&quot;_1FonlY&quot;:1:&#123;s:3:&quot;cmd&quot;;N;&#125;</code> 当做键值，将键值进行反序列化输出，这时就造成了序列化注入攻击。</p><p>​</p><h3 id="Soap反序列化"><a href="#Soap反序列化" class="headerlink" title="Soap反序列化"></a>Soap反序列化</h3><p><code>SOAP</code> : <code>Simple Object Access Protocol</code>简单对象访问协议。</p><p>采用HTTP作为底层通讯协议，XML作为数据传送的格式，正常情况下的<code>SoapClient</code>类，调用一个不存在的函数，会去调用<code>__call</code>方法。</p><p><strong>CRLF漏洞</strong></p><p><code>SOAPAction</code>处可控，可以把<code>\x0d\x0a</code>注入到<code>SOAPAction</code>，POST请求的header就可以被控制。</p><p>但<code>Content-Type</code>在<code>SOAPAction</code>的上面，就无法控制<code>Content-Type</code>，也就不能控制POST的数据。</p><p>在header里<code>User-Agent</code>在<code>Content-Type</code>前面，<code>user_agent</code>同样可以注入<code>CRLF</code>，控制<code>Content-Type</code>的值。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1:5555/path&#x27;</span>;</span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">&#x27;data=something&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=my_session&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.join(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>.(<span class="keyword">string</span>)strlen(<span class="variable">$post_string</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_string</span>,<span class="string">&#x27;uri&#x27;</span>      =&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$aaa</span> = serialize(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$aaa</span> = str_replace(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="variable">$aaa</span> = str_replace(<span class="string">&#x27;&amp;&#x27;</span>,<span class="string">&#x27;&amp;&#x27;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$aaa</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$c = unserialize($aaa);</span></span><br><span class="line"><span class="comment">//$c-&gt;not_exists_function();</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>如上，使用SoapClient反序列化+CRLF<strong>可以生成任意POST请求</strong>。</p><p><strong><code>Deserialization + __call + SoapClient + CRLF = SSRF</code></strong></p><p>​</p><h3 id="python反序列化"><a href="#python反序列化" class="headerlink" title="python反序列化"></a>python反序列化</h3><ul><li>与PHP类似，python也有序列化功能以长期储存内存中的数据。pickle是python下的序列化与反序列化包。</li><li>python有另一个更原始的序列化包marshal，现在开发时一般使用pickle。</li><li>与json相比，pickle以二进制储存，不易人工阅读；json可以跨语言，而pickle是Python专用的；pickle能表示python几乎所有的类型（包括自定义类型），json只能表示一部分内置类型且不能表示自定义类型。</li><li>pickle实际上可以看作一种<strong>独立的语言</strong>，通过对opcode的更改编写可以执行python代码、覆盖变量等操作。直接编写的opcode灵活性比使用pickle序列化生成的代码更高，有的代码不能通过pickle序列化得到（pickle解析能力大于pickle生成能力）。</li></ul><p>参考：</p><p><a target="_blank" rel="noopener" href="https://www.f4de.ink/pages/20ac5e/#pickle%EF%BC%9Apython%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%BA%93">Python-Pickle反序列化安全问题</a></p><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7436">pickle反序列化初探</a></p><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html">Code-Breaking中的两个Python沙箱</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/DEADF1SH-CAT/p/12465346.html">pickle反序列化—高校抗“疫”网络安全分享赛</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/89132768">从零开始python反序列化攻击：pickle原理解析 &amp; 不用reduce的RCE姿势</a></p><p>​</p><h3 id="JDBC反序列化"><a href="#JDBC反序列化" class="headerlink" title="JDBC反序列化"></a>JDBC反序列化</h3><p><a target="_blank" rel="noopener" href="https://github.com/codeplutos/MySQL-JDBC-Deserialization-Payload">MySQL客户端jdbc反序列化漏洞</a></p><p>​</p><h3 id="框架反序列化（CVE）"><a href="#框架反序列化（CVE）" class="headerlink" title="框架反序列化（CVE）"></a>框架反序列化（CVE）</h3><ul><li><h5 id="Yii2"><a href="#Yii2" class="headerlink" title="Yii2"></a>Yii2</h5><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8307">CVE-2020-15148 Yii2反序列化RCE POP链分析</a></p><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/217930">我是如何挖掘yii2反序列化0day的</a></p></li><li><h5 id="Laravel"><a href="#Laravel" class="headerlink" title="Laravel"></a>Laravel</h5><ul><li><p>v5.8</p><p><a target="_blank" rel="noopener" href="https://www.bbsmax.com/A/ZOJPvDnldv/">Laravel 5.8 RCE 分析</a></p></li></ul></li><li><h5 id="ThinkPHP"><a href="#ThinkPHP" class="headerlink" title="ThinkPHP"></a>ThinkPHP</h5><ul><li><p>v5.1.x</p><p><a target="_blank" rel="noopener" href="https://nikoeurus.github.io/2019/12/31/ThinkPHP%205.1.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">ThinkPHP 5.1.x反序列化</a></p></li></ul></li></ul><h3 id="PHPGGC"><a href="#PHPGGC" class="headerlink" title="PHPGGC"></a>PHPGGC</h3><p>PHPGGC是一款能够自动生成主流框架的序列化测试payload的工具。</p><p><a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc">PHPGGC: PHP Generic Gadget Chains</a></p><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5450">从0到1掌握反序列化工具之PHPGGC</a></p></div><div class="article-footer"></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2020/05/16/web-SQL%E6%B3%A8%E5%85%A5/" title="SQL注入"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2020/05/15/web-RCE/" title="RCE"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat" data-mobile-sites="weibo,qq,wechat"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>这篇文章对你有用，赏一波~~</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">⎝Lazzaro⎠</p><p class="text-grey">打开支付宝扫一扫即可扫码打赏激励哦~</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">⎝Lazzaro⎠</p><p class="text-grey">打开微信扫一扫即可扫码打赏激励哦~</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/Lazzzaro" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li></ul><div class="copyright">&copy; 2021 Lazzaro<br><span>总访问 - <span id="busuanzi_value_site_pv"></span>次</span><br><span>访客数 - <span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"类别",TAGS:"关键词",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"sK4BUsDgfSB843HYgJyTcV7P-gzGzoHsz",appKey:"NKNx8m2CtFeDofr8LNLX7aNG",placeholder:"来来来说点啥~~\r\n对你有用？赏一波！↘↘",avatar:"mp",meta:meta,pageSize:"10",visitor:!0})</script><script defer type="text/javascript">!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-165804489-1","auto"),ga("send","pageview")</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e7553a1c385e5487b8ef58cd5738e112";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px;z-index:2}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>addLoadEvent(()=>{$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code")[0].innerText;e+="\n/**\n* 复制并使用代码请注明引用出处哦~\n* Lazzaro @ https://lazzzaro.github.io\n*/";var n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();e=document.execCommand("copy");document.body.removeChild(n),e?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>